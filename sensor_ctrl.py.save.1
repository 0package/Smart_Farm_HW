import RPi.GPIO as GPIO
import time
from datetime import datetime
import adafruit_dht
import board
import requests
import spidev
import math

import sqlite3

conn = sqlite3.connect("farm.db",check_same_thread=False)
cursor = conn.cursor()

# init Setting ##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Pins
th_pin = 4
soil_pin = 1
co2_pin = 0

led_pin = 5
fan_pin = 23
cooler_pin = 24
water_pin = 13
heater_pin = 26

#RaspberryPi Pin
GPIO.setmode(GPIO.BCM)     #set mode

#sensor
GPIO.setup(th_pin, GPIO.IN)    #Temp, Humi
GPIO.setup(soil_pin, GPIO.IN)  #Soil Moisture
GPIO.setup(co2_pin, GPIO.IN)   #CO2
#device
GPIO.setup(led_pin, GPIO.OUT, initial=GPIO.HIGH)     #LED
GPIO.setup(fan_pin, GPIO.OUT, initial=GPIO.LOW)     #Fan
GPIO.setup(cooler_pin, GPIO.OUT, initial=GPIO.LOW)  #Cooler
GPIO.setup(water_pin, GPIO.OUT, initial=GPIO.HIGH)   #Water
GPIO.setup(heater_pin, GPIO.OUT, initial=GPIO.HIGH)  #Heater

dhtDevice = adafruit_dht.DHT11(board.D4)

#GPIO.output(led_pin, False)
#GPIO.output(fan_pin, False)
#GPIO.output(cooler_pin, False)
#GPIO.output(water_pin, False)
#GPIO.output(heater_pin, False)

#SPI setting
spi = spidev.SpiDev()
spi.open(0,0)
spi.max_speed_hz = 1000000

#CO2 value setting
R1 = 23500
R2 = 10000

cal_A = 1.703
cal_B = 0.2677

#LED value setting
led_on_hour = 6
led_off_hour = 22

#Attributes
first = True
changed = False
update_data = []
alarm_text = {'led':'None','fan':'None','cooler':'None','water':'None','heater':'None'}

# Server URL #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
url = 'https://port-0-server-m7tucm4sab201860.sel4.cloudtype.app/sensors'
burl = 'https://port-0-server-m7tucm4sab201860.sel4.cloudtype.app'

# test_h/w_num #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
user_id = 'user@gmail.com'
#farm_id = 34


# Sensor Data #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#Analog-Digital Convert
def read_adc(channel):
    if channel < 0 or channel > 7:
        return -1
    adc = spi.xfer2([1, (8+channel) << 4, 0])
    data = ((adc[1] & 3) << 8) + adc[2]
    return data

#CO2 init emf
def measure_emf_ini(channel):
    print("초기 EMF 측정 중 (3초 대기)...")
    time.sleep(3)
    emf_values = []
    for _ in range(30):  # 약 6초 동안 측정
        adc_val = read_adc(channel)
        v_out = (adc_val * 3.3) / 1023
        emf = v_out * ((R1 + R2) / R2)
        emf_values.append(emf)
        time.sleep(0.2)
    emf_ini = sum(emf_values) / len(emf_values)
    print(f"[EMF_ini] 초기 기준 전압: {emf_ini:.3f} V")
    return emf_ini


#WATER TIME
def calculate_watering_time(current_moisture, target_moisture, soil_volume_ml=24000, pump_flow_ml_per_sec=33.3):
    if current_moisture >= target_moisture:
        return 0

    required_water_ml = (soil_volume_ml * target_moisture - current_moisture) / 100
    watering_time_sec = required_water_ml / pump_flow_ml_per_sec
    return round(watering_time_sec, 2)

#WATER PERCENT
def moisture_percentage(adc_value, dry_value=1022, wet_value=935):
    adc_value = max(min(adc_value, dry_value), wet_value)
    percent = (dry_value - adc_value) * 100 / (dry_value - wet_value)
    return round(percent, 1)

#CO2 PERCENT
def convert_to_co2(adc_value, emf_ini):
    v_out = (adc_value * 3.3) / 1023
    emf = v_out * ((R1 + R2) / R2)

    ratio = emf / emf_ini
    if ratio <= 0:
        return 0

    co2_ppm = math.pow(10, (cal_A - ratio) / cal_B)
    return round(co2_ppm)


def get_sensor_data():
    cursor.execute("select farm_id from farm_info where id = 0")
    farm = cursor.fetchone()
    farm_id = farm[0]
    #temperature = float(input('Temp>'))
    #humidity = float(input('Humi>'))
    try:
        temperature = round(dhtDevice.temperature, 2)
        humidity = round(dhtDevice.humidity, 2)
        time.sleep(2)
    except:
        temperature = round(dhtDevice.temperature, 2)
        humidity = round(dhtDevice.temperature, 2)
        time.sleep(2)

    adc_soil_val = read_adc(1)
    print(adc_soil_val)
    soil_moisture = moisture_percentage(adc_soil_val)
    
    
    adc_co2_val = read_adc(0)
    co2 = convert_to_co2(adc_co2_val, emf_ini)
    
    ctrl_devices(temperature, humidity, soil_moisture, co2)
    print(f'Temp: {temperature}, Humi: {humidity}, Soil: {soil_moisture}, CO2: {co2}')
    return farm_id, temperature, humidity, soil_moisture, co2

# Control #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

def ctrl_devices(temperature, humidity, soil_moisture, co2):
    global first
    global changed
    global alarm_text
    global update_data
    #0:status, 1:mode, 2: duration, 3: start_time
    cursor.execute('''select status, mode, duration, c_time from auto_ctrl where device = "led"''')
    led = cursor.fetchone()
    cursor.execute('''select status, mode, duration, c_time from auto_ctrl where device = "fan"''')
    fan = cursor.fetchone()
    cursor.execute('''select status, mode, duration, c_time from auto_ctrl where device = "cooler"''')
    cooler = cursor.fetchone()
    cursor.execute('''select status, mode, duration, c_time from auto_ctrl where device = "water"''')
    water = cursor.fetchone()
    cursor.execute('''select status, mode, duration, c_time from auto_ctrl where device = "heater"''')
    heater = cursor.fetchone()

    print("led:",led, "fan:",fan,"cooler:",cooler, "water:", water, "heater:",heater)
    # 1: led, 2: fan, 3: cooler, 4: water, 5: heater
    cursor.execute('''select * from device_status where id = 0''')
    device = cursor.fetchone()
    cursor.execute('''select * from sensor_opt where id = 0''')
    opt = cursor.fetchone()
    tmin = opt[1]
    tmax = opt[2]
    hmin = opt[3]
    hmax = opt[4]
    smin = opt[5]
    smax = opt[6]
    cmin = opt[7]
    cmax = opt[8]
    print("tmin",tmin,"tmax",tmax,"hmin",hmin,"hmax",hmax,"smin",smin,"smax",smax,"cmin",cmin,"cmax",cmax)
    
    if(first):
        if(device[1] == 1):
            GPIO.output(led_pin, GPIO.LOW)
        if(device[2] == 1):
            GPIO.output(fan_pin, GPIO.HIGH)
        if(device[3] == 1):
            GPIO.output(cooler_pin, GPIO.HIGH)
        if(device[4] == 1):
            GPIO.output(water_pin, GPIO.LOW)
        if(device[5] == 1):
            GPIO.output(heater_pin, GPIO.LOW)
        first = False

    #LED
    if led[1] == 1: #auto
        now = datetime.now()
        current_hour = now.hour
        print(f'current hour: {current_hour}')

        print(f'AUTO | LED STATUS {device[1]}')
        if led_on_hour <= current_hour < led_off_hour:
            if device[1] == 0:
                print("auto led on")
                changed = True
                GPIO.output(led_pin, GPIO.LOW)
                cursor.execute('''update device_status set led = 1 where id = 0''')
                conn.commit()
                update_data.append('led')
                alarm_text['led'] = 'led가 켜졌습니다.'
        else:
            if device[1] == 1:
                print("auto led off")
                chagned = True
                GPIO.output(led_pin, GPIO.HIGH)
                cursor.execute('''update device_status set led = 0 where id = 0''')
                conn.commit()
                update_data.append('led')
                alarm_text['led'] = 'led가 꺼졌습니다.'
    else:
        if led[0] == 0:
            print("human led off")
            test_d = cursor.execute('''select duration from auto_ctrl where device = ?''',("led",))
            GPIO.output(led_pin, GPIO.HIGH)
        else:
            print("human led on")
            test_d = cursor.execute('''select duration from auto_ctrl where device = ?''',("led",))
            print(test_d.fetchone())
            GPIO.output(led_pin, GPIO.LOW)
        now = datetime.now()
        print('led[2]', led[2])
        print('now:',datetime.now())
        print('database time:',led[3])
        ctime = datetime.strptime(led[3],"%Y-%m-%d %H:%M:%S.%f")
        diff = datetime.now() - ctime

        if diff.seconds >= led[2]:
            cursor.execute('''update auto_ctrl set mode = 1 where device = "led"''')
            cursor.execute('''update auto_ctrl set duration = 0 where device = "led"''')
            conn.commit()
            print("led duration over, auto on!")
    
            
    #WATER
    if water[1] == 1: 
        if soil_moisture < smin: # dry
            if device[4] == 0: # WATER
                print("auto water on")
                changed = True
                cursor.execute('''update device_status set water = 1 where id = 0''')
                conn.commit()
                update_data.append('water')
                alarm_text['water'] = '토양이 건조합니다'
                GPIO.output(water_pin, GPIO.LOW)
                time.sleep(8)
                GPIO.output(water_pin, GPIO.HIGH)
        elif soil_moisture > smax and device[3] == 1: # watery
            if device[4] == 1:
                print("auto water off")
                changed = True
                cursor.execute('''update device_status set water = 0 where id = 0''')
                conn.commit()
                update_data.append('water')
                alarm_text['water'] = '토양에 수분이 많습니다'
                GPIO.output(water_pin, GPIO.HIGH)
    else:
        if water[0] == 0:
            print("human water off")
            GPIO.output(water_pin, GPIO.HIGH)
        else:
            print("human water on")
            GPIO.output(water_pin, GPIO.LOW)
            
        ctime = datetime.strptime(water[3],"%Y-%m-%d %H:%M:%S.%f")
        diff = datetime.now() - ctime
        if diff.seconds >= water[2]:
            cursor.execute('''update auto_ctrl set mode = 1 where device = "water"''')
            cursor.execute('''update auto_ctrl set duration = 0 where device = "water"''')
            conn.commit()
            print("water duration over, auto on!")
            
            
    #FAN        
    if fan[1] == 1:#auto
        if temperature > tmax or humidity > hmax or co2 > cmax:
            if device[2] == 0: # FAN
                print("auto fan on")
                changed = True
                cursor.execute('''update device_status set fan = 1 where id = 0''')
                conn.commit()
                update_data.append('fan')
                if temperature > tmin:
                    alarm_text['fan'] = '온도가 높습니다'
                elif humidity > hmin:
                    alarm_text['fan'] = '공기 중 수분이 너무높습니다'
                else:
                    alarm_text['fan'] = '이산화탄소 농도가 너무 높습니다'
                
                GPIO.output(fan_pin, True)
            
        elif humidity < hmax or co2 < cmax or temperature < tmax:
            if device[2] == 1:
                print("auto fan off")
                changed = True
                cursor.execute('''update device_status set fan = 0 where id = 0''')
                conn.commit()
                update_data.append('fan')
                if temperature < tmax:
                    alarm_text['fan'] = '온도가 안정적입니다'
                elif humidity < hmax:
                    alarm_text['fan'] = '공기 중 수분이 안정적입니다'
                else:
                    alarm_text['fan'] = '이산화탄소 농도가 적정 수준입니다'

                GPIO.output(fan_pin, False)
    else:
        if fan[0] == 0:
            print("human fan off")
            GPIO.output(fan_pin, False)
        else:
            print("human fan on")
            GPIO.output(fan_pin, True)

        ctime = datetime.strptime(fan[3],"%Y-%m-%d %H:%M:%S.%f")
        diff = datetime.now() - ctime
        if diff.seconds >= fan[2]:
            cursor.execute('''update auto_ctrl set mode = 1 where device = "fan"''')
            cursor.execute('''update auto_ctrl set duration = 0 where device = "fan"''')
            conn.commit()
            print("fan duration over, auto on!")
            
            
    #HEAT
    if heater[1] == 1: #auto
        if temperature < tmin: # HEAT ON
            if device[5] == 0:
                print("auto heater on")
                changed = True
                cursor.execute('''update device_status set heater = 1 where id = 0''')
                conn.commit()
                update_data.append('heater')
                alarm_text['heater'] = '온도가 너무 낮습니다'
                GPIO.output(heater_pin, GPIO.LOW)
        elif temperature > tmax: # HEAT OFF
            if device[5] == 1:
                print("auto heater off")
                changed = True
                cursor.execute('''update device_status set heater = 0 where id = 0''')
                conn.commit()
                update_data.append('heater')
                alarm_text['heater'] = '온도가 너무 높습니다'
                GPIO.output(heater_pin, GPIO.HIGH)
        else: # HEAT OFF
            if device[5] == 1:
                print("auto heater off")
                changed = True
                cursor.execute('''update device_status set heater = 0 where id = 0''')
                conn.commit()
                update_data.append('heater')
                alarm_text['heater'] = '온도가 적정 수준입니다'
                GPIO.output(heater_pin, GPIO.HIGH)
    else:
        if heater[0] == 0:
            print("human heater off")
            GPIO.output(heater_pin, False)
        else:
            print("human heater on")
            GPIO.output(heater_pin, True)

        ctime = datetime.strptime(heater[3],"%Y-%m-%d %H:%M:%S.%f")
        diff = datetime.now() - ctime
        if diff.seconds >= heater[2]:
            cursor.execute('''update auto_ctrl set mode = 1 where device = "heater"''')
            cursor.execute('''update auto_ctrl set duration = 0 where device = "heater"''')
            conn.commit()
            print("heater duration over, auto on!")
                
                
                
    #COOLER
    if cooler[1] == 1:
        if temperature < tmin: #COOLER OFF
            if device[3] == 1:
                print("auto cooler off")
                changed = True
                cursor.execute('''update device_status set cooler = 0 where id = 0''')
                conn.commit()
                update_data.append('cooler')
                alarm_text['cooler'] = '온도가낮습니다'
                GPIO.output(cooler_pin, False)
        elif temperature > tmax: #COOLER ON
            if device[3] == 0:
                print("auto cooler on")
                changed = True
                cursor.execute('''update device_status set cooler = 1 where id = 0''')
                conn.commit()
                update_data.append('cooler')
                alarm_text['cooler'] = '온도가 너무 높습니다'
                GPIO.output(cooler_pin, True)
        else:
            if device[3] == 1: #COOLER OFF
                print("auto cooler off")
                changed = True
                cursor.execute('''update device_status set cooler = 0 where id = 0''')
                conn.commit()
                update_data.append('cooler')
                alarm_text['cooler'] = '온도가 적정 수준입니다'
                GPIO.output(cooler_pin, False)
    else:
        if cooler[0] == 0:
            print("human cooler off")
            GPIO.output(cooler_pin, False)
        else:
            print("human cooler on")
            GPIO.output(cooler_pin, True)

        ctime = datetime.strptime(cooler[3],"%Y-%m-%d %H:%M:%S.%f")
        diff = datetime.now() - ctime
        if diff.seconds >= cooler[2]:
            cursor.execute('''update auto_ctrl set mode = 1 where device = "cooler"''')
            cursor.execute('''update auto_ctrl set duration = 0 where device = "cooler"''')
            conn.commit()
            print("cooler duration over, auto on!")
         




# Test #~~~~~~~~~~~~~~~~~~~~~~~
#start_time = time.time()

emf_ini = measure_emf_ini(0)
while True:
    print("Running...")
    time.sleep(5)
    cursor.execute('''select farm_id from farm_info where  id = 0''')
    run_state = cursor.fetchone()
    
    if run_state[0] != 0:
        #if time.time() - start_time > 180:
        #    print('Program stopped after 3 minutes')
        #    break
 
        farm_id, temperature, humidity, soil_moisture, co2 = get_sensor_data()
        data = {'farm_id':farm_id, 'temperature':temperature, 'humidity':humidity, 'soil_moisture':soil_moisture, 'co2':co2}
        #set_devices()
        ctrl_devices(temperature, humidity, soil_moisture, co2)
        try:
            #POST Request
            response = requests.post(url, json=data)
            if response.status_code == 200:
                print(f'Data Sent: {data}')
            else:
                print(f'Error:{response.status_code} - {response.text}')
                print(response.text)
        except requests.RequestException as e:
            print(f'Network Error : {e}')
        except KeyboardInterrupt:
            GPIO.cleanup()
            time.sleep(2)
            break

        cursor.execute("select led, fan, cooler, water, heater from device_status where id = 0")
        sdata = cursor.fetchone()
        
        if changed:
            for device in update_data:
                cursor.execute(f'''select {device} from device_status where id = 0''')
                cdata = cursor.fetchone()
                print("device", device,"status",cdata[0],'content',alarm_text[device])
                chdata = {'farm_id':farm_id, 'device':device, 'status':cdata[0], 'content':alarm_text[device]} 
                try:
                    response = requests.post(f'{burl}/devices/{device}/status',json=chdata)
                    if response.status_code == 200:
                        print(f'Data Sent: {chdata}')
                    else:
                        print(f'Error:{response.status_code} - {response.text}')
                except requests.RequestException as e:
                    print(f'Network Error : {e}')    
            update_data = []
            changed = False
    else:
        GPIO.output(led_pin, GPIO.HIGH)     #LED
        GPIO.output(fan_pin, GPIO.LOW)     #Fan
        GPIO.output(cooler_pin,GPIO.LOW)  #Cooler
        GPIO.output(water_pin, GPIO.HIGH)   #Water
        GPIO.output(heater_pin,GPIO.HIGH)  #Heater

    
                
    time.sleep(1)


GPIO.cleanup
